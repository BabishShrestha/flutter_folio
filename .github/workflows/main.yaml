name: Build and Deploy

on:
  push:
    branches:
      - main  # or the branch you want to trigger the build on


jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.22.2'  # Specify the version you need

    - name: Build Release
      run: |
        flutter --version
        flutter build web

    - name: Deploy to Another Repo
      env:
        TARGET_REPO:  BabishShrestha/babishshrestha.github.io  # Replace with your target repo
        TARGET_BRANCH: deploy_repo  # The branch you want to deploy to in the target repo
        PERSONAL_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}  # Your GitHub token
      run: |
        # Configure Git
        git config --global user.name 'Babish Shrestha'
        git config --global user.email 'babishshrestha8@gmail.com'
        if [ -d "deploy_repo" ]; then
          echo "Removing existing deploy_repo directory"
          rm -rf deploy_repo
        fi

        # Clone the target repository
        echo "Cloning $TARGET_REPO into deploy_repo"

        # Clone the target repository and switch to the target branch
        git clone --branch $TARGET_BRANCH https://$PERSONAL_TOKEN@github.com/$TARGET_REPO deploy_repo || \
        (git clone https://$PERSONAL_TOKEN@github.com/$TARGET_REPO deploy_repo && cd deploy_repo && git checkout -b $TARGET_BRANCH)
        cd deploy_repo
        git checkout $TARGET_BRANCH || git checkout -b $TARGET_BRANCH
        git remote -v
        # Sync the built web files to the cloned repo
        rsync -av --delete ../build/web/ /home/

        # Commit and push changes
        git add .
        git commit -m "Deploy new release"
        git config --unset-all http.https://github.com/.extraheader
        git push https://$PERSONAL_TOKEN@github.com/$TARGET_REPO.git $TARGET_BRANCH
